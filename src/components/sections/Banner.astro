---
// Components
import Link from "../ui/Link.astro";

// Libs
import { getBanner } from "../../lib/api/banner";
import { marked } from "marked";

// Get banner data from API
const bannerData = await getBanner();

// Fallback data if API fails
const defaultData = {
  title: "More Fizzy, More Fun",
  description:
    "Subscribe and save 15% on your favorite flavors when you join our fam. Choose any delivery window that works for you, gain access to new flavors, and get free shipping—always.",
  button_text: "Subscribe & Save",
  button_link: "#",
  image: "/images/banner-image.png",
};

const data = bannerData || defaultData;

// Parse markdown description
const parsedDescription = await marked.parse(data.description);
---

<!-- Pop-up Banner Modal -->
<div
  id="banner-popup"
  class:list={[
    "fixed",
    "inset-0",
    "z-50",
    "hidden",
    "items-center",
    "justify-center",
    "pointer-events-none",
  ]}
  role="dialog"
  aria-modal="true"
  aria-labelledby="banner-title"
>
  <!-- Modal Container -->
  <div
    class:list={[
      "relative",
      "bg-white",
      "rounded-lg",
      "shadow-2xl",
      "max-w-[650px]",
      "w-full",
      "mx-4",
      "overflow-hidden",
      "max-h-[90vh]",
      "flex",
      "flex-col",
      "pointer-events-auto",
    ]}
  >
    <!-- Close Button -->
    <button
      id="banner-close"
      class:list={[
        "absolute",
        "top-4",
        "right-4",
        "z-10",
        "w-7",
        "h-7",
        "flex",
        "items-center",
        "justify-center",
        "rounded-full",
        "bg-white",
        "bg-opacity-90",
        "hover:bg-opacity-100",
        "text-gray-600",
        "hover:text-gray-800",
        "transition-all",
        "duration-200",
        "font-light",
        "text-xl",
        "leading-none",
      ]}
      aria-label="Close banner"
    >
      ×
    </button>

    <!-- Top Section - Image -->
    <div
      class:list={[
        "relative",
        "w-full",
        "bg-banner-gradient",
        "flex",
        "items-center",
        "justify-center",
      ]}
    >
      <img
        src="/images/banner-image.png"
        alt={data.title}
        title={data.title}
        class:list={[
          "w-full",
          "h-auto",
          "object-contain",
        ]}
        loading="eager"
      />
    </div>

    <!-- Bottom Section - Content -->
    <div
      class:list={[
        "bg-beige-50",
        "px-8",
        "py-8",
        "flex",
        "flex-col",
      ]}
    >
      <!-- Title -->
      <h2
        id="banner-title"
        class:list={[
          "text-3xl",
          "lg:text-4xl",
          "font-title",
          "text-green-800",
          "mb-4",
          "font-bold",
          "text-center",
        ]}
      >
        {data.title}
      </h2>

      <!-- Paragraph -->
      <div
        class:list={[
          "text-gray-700",
          "text-base",
          "lg:text-lg",
          "leading-relaxed",
          "mb-6",
          "text-left",
        ]}
        set:html={parsedDescription}
      />

      <!-- Button -->
      <div class="flex justify-center">
        <a
          href={data.button_link}
          class:list={[
            "inline-block",
            "bg-coral-orange",
            "text-white",
            "px-8",
            "py-4",
            "rounded-lg",
            "font-semibold",
            "text-lg",
            "transition-all",
            "duration-300",
            "hover:bg-coral-orange-dark",
            "hover:scale-105",
            "shadow-md",
            "hover:shadow-lg",
          ]}
        >
          {data.button_text}
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Banner Pop-up Logic
  (function () {
    const STORAGE_KEY = "banner-popup-dismissed";
    const popup = document.getElementById("banner-popup");
    const closeButton = document.getElementById("banner-close");

    if (!popup || !closeButton) return;

    // Check if banner was previously dismissed
    const wasDismissed = localStorage.getItem(STORAGE_KEY);
    
    // Show popup if not dismissed (with a small delay for better UX)
    if (!wasDismissed) {
      setTimeout(() => {
        if (popup) {
          popup.classList.remove("hidden");
          popup.classList.add("flex");
        }
      }, 1000); // Show after 1 second
    }

    // Close button handler
    closeButton.addEventListener("click", () => {
      closeBanner();
    });


    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && popup && !popup.classList.contains("hidden")) {
        closeBanner();
      }
    });

    function closeBanner() {
      if (!popup) return;
      popup.classList.add("hidden");
      popup.classList.remove("flex");
      localStorage.setItem(STORAGE_KEY, "true");
    }
  })();
</script>

<style>
  /* Custom beige color for the bottom section */
  .bg-beige-50 {
    background-color: #f5f5dc;
  }

  /* Gradient background for top section - light green-blue to beige */
  .bg-banner-gradient {
    background: linear-gradient(to bottom, #e8f5e9 0%, #f5f5dc 100%);
  }

  /* Coral orange button color */
  .bg-coral-orange {
    background-color: #ff6b6b;
  }

  .bg-coral-orange-dark {
    background-color: #ee5a5a;
  }
</style>
